#!/usr/bin/env bash

DOJO_UNIT_HOME=..
PROJECT_NAME=${1}
DEST=.
TEMPLATE_PROJECT_NAME=c_project_template
TEMPLATE_PROJECT=${DOJO_UNIT_HOME}/${TEMPLATE_PROJECT_NAME}
TARGET=${DEST}/${PROJECT_NAME}
PROJECT_NAME_UPPER=$(echo "$PROJECT_NAME" | tr '[:lower:]' '[:upper:]' | tr -C '[:alnum:]' '_')
TEMPLATE_PROJECT_NAME_UPPER=$(echo "$TEMPLATE_PROJECT_NAME" | tr '[:lower:]' '[:upper:]')
OS_NAME=$(uname -s)

mkdir -p ${TARGET}/src ${TARGET}/tests
cp -r ${TEMPLATE_PROJECT}/Makefile ${TEMPLATE_PROJECT}/sources.mk ${TEMPLATE_PROJECT}/${OS_NAME}.mk ${TEMPLATE_PROJECT}/README ${TEMPLATE_PROJECT}/scripts ${TEMPLATE_PROJECT}/lib ${TARGET}
cp ${TEMPLATE_PROJECT}/src/subdir.mk ${TARGET}/src/ 
cp ${TEMPLATE_PROJECT}/tests/subdir.mk ${TARGET}/tests/
sed -e s/${TEMPLATE_PROJECT_NAME}/${PROJECT_NAME}/ ${TEMPLATE_PROJECT}/objects.mk > ${TARGET}/objects.mk
sed -e s/${TEMPLATE_PROJECT_NAME}/${PROJECT_NAME}/ ${TEMPLATE_PROJECT}/src/${TEMPLATE_PROJECT_NAME}.c > ${TARGET}/src/${PROJECT_NAME}.c
sed -e s/${TEMPLATE_PROJECT_NAME}/${PROJECT_NAME}/ -e s/${TEMPLATE_PROJECT_NAME_UPPER}/${PROJECT_NAME_UPPER}/ ${TEMPLATE_PROJECT}/src/${TEMPLATE_PROJECT_NAME}.h > ${TARGET}/src/${PROJECT_NAME}.h
sed -e s/${TEMPLATE_PROJECT_NAME}/${PROJECT_NAME}/ ${TEMPLATE_PROJECT}/tests/${TEMPLATE_PROJECT_NAME}_tests.c > ${TARGET}/tests/${PROJECT_NAME}_tests.c
sed -e s/${TEMPLATE_PROJECT_NAME}/${PROJECT_NAME}/ -e s/${TEMPLATE_PROJECT_NAME_UPPER}/${PROJECT_NAME_UPPER}/ ${TEMPLATE_PROJECT}/tests/${TEMPLATE_PROJECT_NAME}_tests.h > ${TARGET}/tests/${PROJECT_NAME}_tests.h
